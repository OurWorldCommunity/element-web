(window.webpackJsonp=window.webpackJsonp||[]).push([[37],{1406:function(e,t,n){"use strict";n.r(t),n.d(t,"sendMessage",(function(){return M})),n.d(t,"editMessage",(function(){return R}));var a=n(26),o=n.n(a),r=n(33),i=n(107),c=n(5),s=n(344),l=n(207),d=n(405),u=n(610),m=n(8),b=n(340),g=n(1288),p=n(1),f=n.n(p),y=n(1305),v=n(14),O=n(156);function j(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function C(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?j(Object(n),!0).forEach((function(t){f()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):j(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const E="/me ";const h=e=>e instanceof v.MatrixEvent;async function _(e,t,n){let{relation:a,replyToEvent:o,permalinkCreator:r,includeReplyLegacyFallback:i=!0,editedEvent:s}=n;const l=h(s),d=l?Boolean(s.replyEventId):h(o),u=l&&d,m=e.startsWith(E);m&&(e=e.slice(E.length)),e.startsWith("//")&&(e=e.slice(1));const b=t?await Object(y.richToPlain)(e):e,g=u&&function(e){const t=e.getContent().body;if("string"!=typeof t)return"";const n=t.split("\n").map((e=>e.trim()));return n.length>2&&n[0].startsWith("> ")&&0===n[1].length?`${n[0]}\n\n`:""}(s)||"",p=u&&function(e){const t=e.getContent().formatted_body;if(!t)return"";const n=(new DOMParser).parseFromString(t,"text/html").body.querySelector("mx-reply");return n&&n.outerHTML||""}(s)||"",f={msgtype:m?v.MsgType.Emote:v.MsgType.Text,body:l?`${g} * ${b}`:b},j=c.b.getValue("MessageComposerInput.useMarkdown"),_=t?e:j?await Object(y.plainToRich)(e):null;_&&(f.format="org.matrix.custom.html",f.formatted_body=l?`${p} * ${_}`:_),l&&(f["m.new_content"]={msgtype:f.msgtype,body:b},_&&(f["m.new_content"].format="org.matrix.custom.html",f["m.new_content"].formatted_body=_));return function(e,t){t&&(e["m.relates_to"]=C(C({},e["m.relates_to"]||{}),t))}(f,l?C(C({},a),{},{rel_type:"m.replace",event_id:s.getId()}):a),!l&&o&&r&&Object(O.a)(f,o,{permalinkCreator:r,includeLegacyFallback:i}),f}var w=n(121),k=n(238),T=n(13),x=n(337);const S=["roomContext","mxClient"];async function M(e,t,n){var a;let{roomContext:b,mxClient:g}=n,p=o()(n,S);const{relation:f,replyToEvent:y,permalinkCreator:v}=p,{room:j}=b,C=null==j?void 0:j.roomId;if(!C)return;const h={eventName:"Composer",isEditing:!1,isReply:Boolean(y),inThread:(null==f?void 0:f.rel_type)===r.d.name};i.a.instance.trackEvent(h);let M=null;if(e.startsWith("/")&&!e.startsWith("//")&&!e.startsWith(E)){const{cmd:t,args:n}=Object(w.d)(e);if(t){const e=(null==f?void 0:f.rel_type)===r.d.name?null==f?void 0:f.event_id:null;let a;if([M,a]=await Object(k.c)(g,t,n,C,null!=e?e:null),!a)return;if(!M||t.category!==w.a.messages&&t.category!==w.a.effects)return;var R,P;Object(x.b)(M,f),y&&Object(O.a)(M,y,{permalinkCreator:v,includeLegacyFallback:null===(R=null===(P=M.msgtype)||void 0===P?void 0:P.startsWith("m."))||void 0===R||R})}else{const t=await Object(k.d)(e);if(m.a.dispatch({action:T.a.FocusAComposer,context:b.timelineRenderingType}),!t)return}}if(null!==(a=M)&&void 0!==a||(M=await _(e,t,p)),!M.body.trim())return;c.b.getValue("Performance.addSendMessageTimingMetadata")&&Object(s.a)(M);const F=null!=f&&f.event_id&&(null==f?void 0:f.rel_type)===r.d.name?f.event_id:null,D=Object(l.a)(C,(e=>g.sendMessage(e,F,M)),g);return y&&m.a.dispatch({action:"reply_to_event",event:null,context:b.timelineRenderingType}),m.a.dispatch({action:"message_sent"}),d.CHAT_EFFECTS.forEach((e=>{if(M&&Object(u.containsEmoji)(M,e.emojis)){(null==f?void 0:f.rel_type)!==r.d.name&&m.a.dispatch({action:`effects.${e.command}`})}})),c.b.getValue("Performance.addSendMessageTimingMetadata")&&D.then((e=>{Object(s.b)(g,C,e.event_id)})),c.b.getValue("scrollToBottomOnMessageSent")&&m.a.dispatch({action:"scroll_to_bottom",timelineRenderingType:b.timelineRenderingType}),D}async function R(e,t){let{roomContext:n,mxClient:a,editorStateTransfer:o}=t;const r=o.getEvent();i.a.instance.trackEvent({eventName:"Composer",isEditing:!0,inThread:Boolean(null==r?void 0:r.getThread()),isReply:Boolean(r.replyEventId)});const c=await _(e,!0,{editedEvent:r}),s=c["m.new_content"];if(""===(null==s?void 0:s.body))return Object(g.a)(a,o),void Object(b.a)({mxEvent:r,onCloseDialog:()=>{Object(g.b)(n)}});let l;const d=r.getRoomId();if(function(e,t){const n=t.getEvent().getContent();return n.msgtype!==e.msgtype||n.body!==e.body||n.format!==e.format||n.formatted_body!==e.formatted_body}(s,o)&&d){Object(g.a)(a,o);const e=o.getEvent().threadRootId||null;l=a.sendMessage(d,e,c),m.a.dispatch({action:"message_sent"})}return Object(g.b)(n),l}},1553:function(e,t,n){"use strict";n.r(t),n.d(t,"default",(function(){return P}));var a=n(18),o=n.n(a),r=n(26),i=n.n(r),c=n(0),s=n.n(c),l=n(12),d=n.n(l),u=n(1402),m=n(2),b=n(9);function g(e){let{onCancelClick:t,onSaveClick:n,isSaveDisabled:a=!1}=e;return s.a.createElement("div",{className:"mx_EditWysiwygComposer_buttons"},s.a.createElement(b.a,{kind:"secondary",onClick:t},Object(m.b)("Cancel")),s.a.createElement(b.a,{kind:"primary",onClick:n,disabled:a},Object(m.b)("Save")))}var p=n(8),f=n(13),y=n(31),v=n(608),O=n(1286),j=n(414),C=n(1287),E=n(1273);var h=n(30),_=n(1288),w=n(1406);var k=n(314),T=n(50),x=n(5);function S(e){const t=Object(y.c)(),n=Object(h.b)();return Object(c.useMemo)((()=>{if(e&&t.room&&n)return function(e,t,n){const a=new T.a(t,n);let o=[];if(e.hasEditorState()){const t=e.getSerializedParts();null!==t&&(o=t.map((e=>a.deserializePart(e))))}else{if("org.matrix.custom.html"===e.getEvent().getContent().format)return function(e){var t;return(null===(t=e.getEvent().getContent().formatted_body)||void 0===t?void 0:t.replace(/<mx-reply>.*<\/mx-reply>/,""))||""}(e);o=Object(k.b)(e.getEvent(),a,{shouldEscape:x.b.getValue("MessageComposerInput.useMarkdown")})}return o.reduce(((e,t)=>e+(null==t?void 0:t.text)),"")}(e,t.room,n)}),[e,t,n])}const M=["editorStateTransfer","className"],R=Object(c.forwardRef)((function(e,t){let{disabled:n=!1,composerFunctions:a}=e;return function(e,t,n){const a=Object(y.c)(),o=Object(E.c)(),r=Object(c.useRef)(null),i=Object(c.useCallback)((i=>{var c;if(e||!t.current)return;const s=null!==(c=i.context)&&void 0!==c?c:y.a.Room;switch(i.action){case f.a.FocusEditMessageComposer:Object(O.a)(t,s,a,r);break;case f.a.ComposerInsert:if(i.timelineRenderingType!==a.timelineRenderingType)break;if(i.composerType!==j.a.Edit)break;i.text&&Object(C.d)(o.selection).then((()=>n.insertText(i.text)))}}),[e,t,n,r,a,o]);Object(v.a)(p.a,i)}(n,t,a),null}));function P(e){let{editorStateTransfer:t,className:n}=e,a=i()(e,M);const r=Object(c.useRef)(Object(E.b)({editorStateTransfer:t})),l=S(t),m=!t||void 0!==l,{editMessage:b,endEditing:p,onChange:f,isSaveDisabled:v}=function(e,t){const n=Object(y.c)(),a=Object(h.b)(),[o,r]=Object(c.useState)(!0),[i,s]=Object(c.useState)(t);return{onChange:Object(c.useCallback)((e=>{s(e),r((n=>n&&e===t))}),[t]),editMessage:Object(c.useCallback)((async()=>{if(void 0!==a&&void 0!==i)return Object(w.editMessage)(i,{roomContext:n,mxClient:a,editorStateTransfer:e})}),[i,n,a,e]),endEditing:Object(c.useCallback)((()=>Object(_.b)(n)),[n]),isSaveDisabled:o}}(t,l);return m?s.a.createElement(E.a.Provider,{value:r.current},s.a.createElement(u.a,o()({className:d()("mx_EditWysiwygComposer",n),initialContent:l,onChange:f,onSend:b},a),((e,t)=>s.a.createElement(s.a.Fragment,null,s.a.createElement(R,{disabled:a.disabled,ref:e,composerFunctions:t}),s.a.createElement(g,{onCancelClick:p,onSaveClick:b,isSaveDisabled:v}))))):s.a.createElement(s.a.Fragment,null)}}}]);
//# sourceMappingURL=37.js.map